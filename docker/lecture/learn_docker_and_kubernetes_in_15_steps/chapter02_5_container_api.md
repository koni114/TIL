# 컨테이너 API
- 컨테이너 API는 컨테이너를 블랙박스처럼 다룰 수 있게 해주는 인터페이스. 이는 쿠버네티스 환경에서도 사용됨
- 인터페이스란, 원래 하드웨어 간 접속을 위한 규격이나 케이블 연결 사양을 의미함  
  소프트웨어에서도 이와 비슷하게 서로 다른 팀이 개발한 프로그램들을 연결하기 위해 서로 지켜야 하는 규격을 말함
- 도커 컨테이너에 API가 있다면 컨테이너 내부 프로그램에 대해 잘 알지 못해도 간단하게 재이용 하는 것이 가능함

## 컨테이너 API의 종류와 개요
![img](https://github.com/koni114/TIL/blob/master/docker/img/docker_13.jpeg)

### 컨테이너 기동
- 컨테이너 내의 애플리케이션은 기동 시에 환경 변수나 실행 인자를 읽어서 그에 맞게 도작하게 만들 수 있음

### 헬스 체크(쿠버네티스 환경)
- <b>준비 완료 프로브</b>는 컨테이너의 애플리케이션이 초기화가 완료되어 외부로부터의 요청을 받을 수 있게 되었음을 알리는 인터페이스
- 로드밸런서가 컨테이너에 요청을 전달하기 시작해도 될지 확인하기 위한 목적으로 사용됨 
- <b>활성 프로브</b>는 애플리케이션의 기동 상태(정상/비정상)을 알리는 인터페이스  
  비정상이 감지되면 쿠버네티스가 컨테이너를 재기동하여 복구를 시도함

### 컨테이너 종료
- 컨테이너 내의 애플리케이션은 종료 요청 시그널(SIGTERM)에 대한 종료 처리를 구현하는 것이 좋음
- 종료 처리란 메모리의 값을 보존하거나 데이터베이스와의 세션을 종료한 뒤 정상 종료하는 것을 말함
- 강제 종료 시그널(SIGKILL)은 제한 시간 내에 종료 처리가 완료되지 않은 경우 컨테이너를 강제 종료하기 위해 사용됨  
  애플리케이션이 강제 종료를 막을 수 있는 방법은 없음

### 서비스
- 컨테이너 위에 돌아가는 서버 애플리케이션은 특정 포트를 통해 클라이언트로부터의 요청을 받아드림
- 특정 포트번호로 클라이언트로부터의 요청을 받고, 처리 결과를 반환하는 역할 수행
- 컨테이너의 포트를 호스트의 IP 주소에 포트 포워딩을 하여 외부에서의 요청을 받아드려야 함
- 쿠버네티스에서는 컨테이너를 담는 파드에 포트를 열어 클라이언트로부터의 요청을 받음

### 로그
- 마이크로서비스 아키텍처를 사용하고 규모가 커지게 되면 보통 수많은 컨테이너를 돌리게 됨
- 그러면 로그의 양도 늘어나게 되는데 , 도커나 쿠버네티스에서는 로그를 일관되게 관리하여 컨테이너의 표준 출력(STDOUT)과 표준 오류(STDERR)를 로그로 간직함
- 컨테이너의 애플리케이션은 로그를 파일에 쓰는 것이 아니라, 표준 출력이나 표준 오류에 쓰면 됨

### 후크(쿠버네티스 환경)
- 컨테이너는 후크에 의해 실행될 스크립트, 혹은 HTTP 요청 처리를 구현해야 함
- Dockerfile의 ENTRYPOINT 나, CMD로 지정한 명령어와 후크는 비동기적으로 실행되어 실행 순서가 보장되지 않음

## 퍼시스턴트 볼륨
- 컨테이너에서 퍼시스턴트 볼륨을 사용하는 대표적인 경우는 <b>설정 파일을 외부에서 주입하는 경우</b>와 <b>발생 데이터를 보존하는 경우</b> 두 가지가 있음
- 애플리케이션이 읽어 들일 설정 파일을 외부에서 주입하는데, 그러면 설정 파일을 바꾸기 위해 이미지를 다시 빌드하지 않아도 되어 재사용성이 높아짐
- 주입하는 방법은 설정 파일을 담은 디렉터리를 컨테이너의 특정 디렉터리에 마운트하면 됨
- 인증서와 같이 민감한 데이터의 경우에도 리포지터리에 등록해서는 안됨. 이러한 경우에도 PV를 사용하여 외부에서 컨테이너를 주입해야 함
- 쿠버네티스에서는 보안에 민감한 데이터를 다루기 위한 <b>시크릿</b>과 일반적인 설정을 다루는 <b>컨피그맵</b>이 있음
- 컨테이너가 삭제되면 데이터도 삭제되기 때문에 보관이 필요한 데이터를 컨테이너의 파일 저장 시스템에 저장해서는 안됨

## 종료 상태
- PID가 1인 프로세스의 Exit 코드가 컨테이너의 종료 코드로 설정됨
- 쿠버네티스에서는 컨테이너가 종료 코드 0으로 종료하면 정상 종료로 취급하고, 그 외의 값인 경우는 비정상 종료로 취급함


## 용어 정리
- 퍼시스텀트 볼륨(PV)
  - 물리 저장 장치(volume)를 표현하는 쿠버네티스의 자원 
  - PV를 파드에 연결해 사용하려면 퍼시스턴트 볼륨 클레임(PVC) 객체가 필요