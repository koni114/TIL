# chapter01 - apache airflow 살펴보기
## Airflow 소개
### 파이썬 코드로 유연한 파이프라인 정의
- airflow를 사용하게 되면 파이프라인이나 워크플로 테스크를 DAG로 정의 가능
- airflow는 파이썬 스크립트로 DAG의 구조를 설명하고 구성함  
  즉, 일반적으로 각 DAG 파일은 주어진 DAG에 대한 태스크 집합과 태스크 간의 의존성을 기술하고, Airflow는 DAG 구조를 식별하기 위해 코드를 파싱함
- 그 외에도 DAG 파일에는 Airflow의 실행 방법, 시간 등을 정의한 몇가지 메타데이터가 포함됨

### 파이프라인 스케줄링 및 실행
- DAG로 파이프라인 구조를 정의하고 난 후, 파이프라인을 언제 실행할 것인지 각각의 DAG의 실행 주기를 정의할 수 있음
- 다음은 Airflow DAG에 대한 개발과 실행 프로세스 전체에 대해서 살펴보자.  

#### Airflow 구성 요소 3가지
- Airflow 스케줄러
  - DAG를 분석하고 현재 시점에서 DAG의 스케줄이 지난 경우 Airflow 워커에 DAG의 태스크를 예약함 
- Airflow 워커
  - 예약된 테스크를 선택하고 실행함 
- Airflow 웹 서버
  - 스케줄러에서 분석한 DAG를 시각화하고 DAG 실행과 결과를 확인할 수 있는 주요 인터페이스를 제공함 
![img](https://github.com/koni114/TIL/blob/master/Data-Engineering/contents/apache-airflow/img/airflow_01.png)

#### airflow 스케줄러 진행 순서
- 사용자가 DAG 워크플로를 작성하면, 스케줄러는 DAG 파일을 분석하고 각 DAG 테스크, 의존성 및 예약 주기를 확인함
- 스케줄러는 마지막 DAG까지 내용을 확인한 후 DAG의 예약 주기가 경과했는지 확인함  
  예약 주기가 현재 시간 이전이라면 실행되도록 예약함
- 예약된 각 태스크에 대해서 스케줄러는 해당 태스크의 의존성(upstream task)를 확인함  
  의존성 태스크가 완료되지 않았다면 실행 대기열에 추가함
- 스케줄러는 1단계로 돌아간 후 새로운 루프를 잠시 동안 대기함
- 태스크가 실행 대기열에 추가되면, Airflow 워커의 풀(pool) 워커가 태스크를 선택하고 실행함  
  이 때 <b>실행은 병렬로 수행되고, </b> 실행 결과는 지속적으로 추적됨
- 이 과정의 모든 결과는 Airflow 의 메타스토어로 전달되어, 사용자가 Airflow 의 웹 인터페이스(Airflow의 웹 서버에 의해서 제공되는)를 통해 태스크 진행 상황을 추적하고 로그를 확인할 수 있음

#### 모니터링 실패 처리
- airflow는 태스크 실패 시에 재시도 할 수 있음(재실행 시간의 간격을 설정할 수도 있음)
- 재시도가 실패하면 Airflow는 태스크가 실패했음을 기록하고 사용자에게 실패를 통보(사용자가 알림을 설정했을 경우)

### 점진적 로딩 및 백필
- Airflow는 DAG에 정의된 특정 시점에 트리거할 수 있을 뿐만 아니라 최종 시점과 예상되는 다음 스케줄 주기를 상세하게 알려 주는 기능이 있음
- 이를 통해 각각의 주기로 나누고 각 주기별로 DAG을 실행할 수 있음  
- 스케줄 주기가 백필 개념과 결합하여 스케줄 주기를 더욱 강력하게 활용할 수 있으며, 이를 통해 새로 생성한 DAG를 과거 시점 및 기간에 대해 실행이 가능
- 또한 과거 실행 결과를 삭제한 다음, 태스크 코드를 변경한 후에 삭제된 과거 태스크를 쉽게 재실행할 수 있기 때문에 필요할 때 전체 데이터 세트를 간단하게 재구성해 처리할 수 있음

## 언제 Airflow를 사용해야 할까
### airflow 장점
- airflow는 <b>batch 지향 데이터 파이프라인을 구현하는 데 적합함</b>
- 파이썬 코드를 이용해 파이프라인을 구현할 수 있기 때문에 파이썬 언어에서 구현할 수 있는 대부분의 방법을 사용하여 복잡한 커스텀 파이프라인을 만들 수 있음
- 파이썬 기반의 Airflow 는 쉽게 확장 가능하고 다양한 시스템과 통합이 가능함  
- 백필 기능을 사용하면 과거 데이터를 손쉽게 재처리할 수 있음. 코드를 변경한 후 재생성이 필요한 데이터 재처리가 가능함
- Airflow의 훌륭한 웹 인터페이스는 파이프라인 실행 결과를 모니터링 할 수 있고, 오류를 디버깅하기 위한 편리한 뷰를 제공함

### airflow 단점
- airflow 는 반복적이거나 배치 태스크를 실행하는 기능에 초점이 맞춰져 있기 때문에, 스트리밍 워크플로 및 해당 파이프라인 처리에 적합하지 않을 수 있음
- 추가 및 삭제 태스크가 빈번한 동적 파이프라인 경우에는 적합하지 않을 수 있음  
  웹 인터페이스는 DAG의 가장 최근 실행 버전에 대한 정의만 표현해 주기 때문


## 용어 정리
- 백필(backfill)
  - 특정 옵셥 기준으로 다시 실행할 수 있는 기능을 말함. 태스크가 며칠 동안 실패하거나 새롭게 만든 플로를 과거의 특정 시점부터 순차적으로 실행하고 싶을 때 수행

