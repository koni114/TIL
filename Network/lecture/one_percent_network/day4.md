## day 4
### IP와 이더넷의 송.수신 동작
#### 패킷의 기본
- IP 담당 부분이 어떻게 패킷을 상대에게 송신하는지 알아보자
- 패킷의 송신처가 되는 기기가 패킷을 만들고, 가장 가까운 중계 장치에 송신
- 중계 장치는 헤더를 조사하여 패킷을 목적지를 판단  
  이 때 어느 방향에 있는지 표를 확인
- 즉, 표와 헤더에 저장되어 있는 수신처 정보를 결합하여 패킷의 목적지 판단
- 이렇게 차례로 패킷을 중계하면 최종적으로 수신처의 기기 패킷에 도착하면 회답 패킷이 돌아옴
- 송신처와 수신처를 묶어 <b>엔드노드</b> 라고 함
- 이 패킷의 기본은 TCP/IP 네트워크에도 적합하며, TCP/IP 패킷 구조는 좀 더 복잡함  
  서브넷은 라우터와 허브라는 두 종류의 패킷 중계 장치에서 다음의 역할을 분담하면서 패킷을 운반하기 때문
  - 라우터가 목적지를 확인하여 다음 라우터를 나타냄
  - 허브가 서브넷 안에서 패킷을 운반하여 다음 라우터에 도착
- 허브는 이더넷의 규칙에 따라 패킷을 운반하고, 라우터는 IP의 규칙에 따라 패킷을 운반  
  IP가 목적지를 확인하여 다음 IP 중계장치를 나타냄  
  서브넷 안에 있는 이더넷이 중계 장치까지 패킷을 운반
- TCP/IP 패킷에는 다음의 두 개의 헤더가 붙어있음  
  - MAC 헤더(수신처는 다음 라우터)
  - IP 헤더(수신처는 목적지의 서버)

#### IP 패킷을 운반하는 원리
![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_10.png)

- 송신처에서 패킷의 목적지가 되는 대상 서버의 IP 주소를 IP 헤더의 수신처에 기록
- IP는 수신처가 어느 방향에 있는지 조사하여 그 방향에 있는 다음 라우터를 조사
- 거기에 패킷을 도착하도록 이더넷에 의뢰하고, 다음 라우터에 할당된 이더넷의 주소(MAC주소)를 조사하고 MAC 헤더에 기록
- 이렇게 해서 패킷 송신하여 허브에 도착(--> 위 그림 1번에 해당)
- 허브에는 패킷의 목적지를 판단하기 위한 표와 이더넷 헤더의 수신처 정보를 결합하여 패킷의 목적지를 판단하여 중계  
  (허브가 여러개이면, 순차적으로 허브를 경유)
- 패킷은 라우터에 도착(--> 위 그림 2번에 해당)
- 라우터의 IP용 표와 IP 헤더의 수신처와 결합하여 어느 라우터에 패킷을 중계할 것인지 알아냄 
- 다음 라우터에 패킷을 건네주기 위해 라우터의 MAC 주소하고, MAC 헤더에 저장  
  (IP 주소는 그대로, MAC 헤더를 바꿈) --> 위 그림 3번에 해당
- 이것을 반복하면, 패킷은 목적지에 도달
- 이더넷과 IP가 역할을 분담하는데, 이더넷 부분은 무선 LAN, ADSL, FTTH 등 IP의 의뢰를 받아 패킷을 운반할 수 있는 것이면 가능
- 이더넷과 같은 거대한 네트워크를 구축하려면 이러한 유연성이 필요한데, 이것이 역할을 분담하는 이유

#### 패킷 송.수신 동작의 개요 
![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_11.png)

- 다음은 IP 담당 부분의 패킷 송.수신 동작
- IP 담당 부분은 패킷을 상대에게 송출만 하고, 그 뒤에 상대가 있는 곳까지 패킷을 운반하는 것은 허브나 라우터가 수행
- IP 담당 부분은 패킷을 운반하는 동작 전체에서 입구 부분에 불과함
- ① 송신
  - TCP 담당 부분이 TCP 헤더를 데이터에 붙여 IP 담당 부분에 패킷 송신 의뢰하여 건네줌
  - TCP 헤더는 IP 주소를 나타냄
  - 의뢰를 받은 IP 담당 부분은 MAC 헤더를 부가함  
    MAC 헤더는 이더넷 등의 LAN을 사용하여 가장 가까운 라우터까지 패킷을 운반할 때 사용하는 제어 정보 기록
- ② 송신
  - 만든 패킷을 네트워크용 하드웨어에 건네줌  
    하드웨어는 이더넷이나 무선 LAN 등을 말함
  - LAN 어댑터에 건네줄 때의 패킷의 모습은 0, 1 비트가 이어져있는 데이터  
  - 신호는 허브나 라우터 등의 중계 장치에 도착하고, 중계 장치가 상대가 있는 곳까지 패킷을 전달
- ③ 수신
  - 케이블에서 신호의 모습을 한 패킷이 들어오면, 이것을 LAN 어댑터에서 디지털 데이터의 모습으로 되돌림
  - 디지털 데이터를 IP 담당 부분에게 건네줌 
- ④ 수신
  - IP 담당 부분이 MAC 헤더와 IP 헤더 뒤에 이어지는 데이터 조각을 TCP 담당 부분에게 전달
- <b>IP 패킷 송수신 동작은 패킷의 역할에 관계없이 모두 같음</b>  
  TCP 헤더와 데이터 조각을 한 덩어리의 바이너리 데이터로 간주하여 내용을 보지않기 때문

#### 수신처 IP 주소를 기록한 헤더를 만든다
- IP 헤더에서 가장 중요한 것은 수신처 IP 주소
- TCP 담당 부분에서 통지된 통신 상대의 IP 주소를 설정  
  이 IP 주소는 본래 애플리케이션에서 통지된 통신 상대의 IP 주소임
- 송신처 IP 주소도 설정하는데, 이는 통신 상대의 주소를 설정  
  송신처 IP 주소는 송신처가 되는 LAN 어댑터를 판단하여 주소 설정
- 패킷을 건네줄 상대를 판단하는 방법은 라우터가 IP용 표를 사용하여 다음 라우터를 결정하는 동작과 같음  
 이 IP용 표를 경로표라고 함
- 예를 들어 수신처 IP 주소가 192.168.1.21 이면 192.168.1와 일치하는 행을 찾아내고,   
  오른쪽부터 두 번째와 세 번째 항목을 조사함
  - 오른쪽에서 두 번째 Interface 항목은 LAN 어댑터 등의 네트워크용 인터페이스를 나타냄  
    인터페이스에서 패킷을 송신하면 상대에 패킷을 전해줄 수 있다는 의미
  - 오른쪽에서 세 번째 Gateway 항목은 다음 라우터의 IP 주소를 기록하게 되어 있음  
    IP 주소를 가진 라우터에 패킷을 건네주면 라우터가 목적지에 패킷을 중계해 준다는 것을 의미함
- 경로표의 맨 위 행은 목적지와 넷마스크가 0.0.0.0으로 등록되어 있음  
  이것은 소위 기본 게이트웨이를 나타내며, 다른 곳에 일치하는 것이 없으면 이 행이 해당하는 것으로 간주
- 이렇게 해서 어느 LAN 어댑터에서 패킷을 송신해야 하는지 알고 나서 LAN 어댑터에 할당되어 있는 IP 주소를 IP 헤더으티 송신처 IP 주소로 설정
- <b>프로토콜 번호</b>라는 필드 값도 설정하는데, 이는 패킷에 들어간 내용물이 어디에서 의뢰받은 것인지를 나타냄

#### 이더넷용 MAC 헤더를 만든다
- IP 헤더 제작 후, IP 담당 부분 앞에  MAC 헤더를 붙임
- 이더넷에서는 TCP/IP 개념이 통용되지 않으며 이더넷의 수신처 판단 구조로 사용하는 것이 MAC 헤더임
- MAC 헤더의 맨 앞에 있는 수신처 MAC 주소와 그 다음의 송신처 MAC 주소는 각각 패킷을 전달하는 상대와 패킷을 송신한 송신처의 MAC 주소를 나타냄
- MAC 주소는 48 비트(IP 주소는 32비트)
- IP 주소는 00동 00번지의 일종의 그룹화 개념이지만, MAC 주소는 그런 개념이 없음 
- <b>3개의 이더타입</b>이라는 항목은 내용물이 무엇인지를 나타내며, 이더넷의 내용물은 IP나 ARP라는 프로토콜의 소켓임
  - 이더타입 필드 : IP 프로토콜을 나타내는 0800 이라는 값 설정
  - 송신처 MAC 주소 : 자체의 LAN 어댑터의 MAC 주소 설정. 어댑터 제조시 그 안에 있는 ROM에 기록됨
  - 수신처 MAC 주소 : 패킷을 건네주는 상대편 MAC 주소. 이는 경로표에 기록되어 있으며 경로표에서 찾은   
    일치하는 행의 Gateway 항목에 기록되어 있는 IP 주소의 기기가 패킷을 건내주는 상대가 됨
- 이 시점에서 상대의 MAC 주소는 모르기 때문에 IP 주소에서 MAC 주소를 조사하는 동작 실행

#### ARP로 수신처 라우터의 MAC 주소를 조사한다
- MAC 주소를 동작하는 실행에서 ARP(Address Resolution Protocol) 를 사용
- 이더넷에는 연결되어 있는 전원에게 패킷을 전달하는 브로드캐스트라는 구조가 있음  
- 상대가 자신과 같은 네트워크에 존재하면 이것으로 MAC 주소를 알 수 있음  
  그러면 MAC 주소를 MAC 헤더에 설정하여 MAC 헤더를 만듬
- 패킷을 보낼 때마다 이 동작을 수행하면 ARP의 패킷이 불어나기 때문에 한 번 조사한 결과는 ARP 캐시라는 메모리 영역에 보존하여 이용
- ARP 캐시에 저장된 MAC 주소를 언제까지나 계속 사용하면 문제가 발생할 수 있으므로,  
  이를 막기위해 ARP 캐시에 저장된 값은 시간이 되면 삭제하게 되어 있음. 보통 몇 분정도임
- 수신한 패킷을 그대로 IP 담당 부분에 건네주면 단순이 수신만 하면 되므로 IP 이외의 특수한 패킷에도 대응할 수 있음

#### 이더넷의 기본
![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_12.png)
- <b>이더넷</b>은 다수의 컴퓨터가 여러 상대와 자유롭게 적은 비용으로 통신하기 위해 고안된 통신 기술
- 네트워크의 실체는 케이블만 있으며, 트랜시버도 결국 신호를 흐르게하는 케이블임
- 한 대가 신호를 보내면 전원에게 신호가 도착함  
  신호의 맨 앞부분에 누구에게 갈 것인지를 나타내는 정보, 즉 수신처 주소를 써둠
- 최종적으로는 윗 그림의 (c)와 같이 스위칭 허브를 사용한 형태가 보급되었는데, 현재는 이더넷이라고 말하면 이 형태를 의미함  
- 수신처 MAC 주소로 나타내는 원하는 기기가 존재하는 부분에만 신호가 흐르고, 다른 곳에는 신호가 흐르지 않게 된 것 
- 이더넷도 IP와 마찬가지로 패킷의 내용물은 보지 않으므로 이더넷의 송.수신 동작은 TCP 동작 단계에 상관 없이 모든 것에 공통

## 용어 정리
- Gateway
  - TCP/IP 세계에서 라우터를 가리키는 용어 