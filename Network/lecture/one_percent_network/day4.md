## day 4
### IP와 이더넷의 송.수신 동작
#### 패킷의 기본
- IP 담당 부분이 어떻게 패킷을 상대에게 송신하는지 알아보자
- 패킷의 송신처가 되는 기기가 패킷을 만들고, 가장 가까운 중계 장치에 송신
- 중계 장치는 헤더를 조사하여 패킷을 목적지를 판단  
  이 때 어느 방향에 있는지 표를 확인
- 즉, 표와 헤더에 저장되어 있는 수신처 정보를 결합하여 패킷의 목적지 판단
- 이렇게 차례로 패킷을 중계하면 최종적으로 수신처의 기기 패킷에 도착하면 회답 패킷이 돌아옴
- 송신처와 수신처를 묶어 <b>엔드노드</b> 라고 함
- 이 패킷의 기본은 TCP/IP 네트워크에도 적합하며, TCP/IP 패킷 구조는 좀 더 복잡함  
  서브넷은 라우터와 허브라는 두 종류의 패킷 중계 장치에서 다음의 역할을 분담하면서 패킷을 운반하기 때문
  - 라우터가 목적지를 확인하여 다음 라우터를 나타냄
  - 허브가 서브넷 안에서 패킷을 운반하여 다음 라우터에 도착
- 허브는 이더넷의 규칙에 따라 패킷을 운반하고, 라우터는 IP의 규칙에 따라 패킷을 운반  
  IP가 목적지를 확인하여 다음 IP 중계장치를 나타냄  
  서브넷 안에 있는 이더넷이 중계 장치까지 패킷을 운반
- TCP/IP 패킷에는 다음의 두 개의 헤더가 붙어있음  
  - MAC 헤더(수신처는 다음 라우터)
  - IP 헤더(수신처는 목적지의 서버)

#### IP 패킷을 운반하는 원리
![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_10.png)

- 송신처에서 패킷의 목적지가 되는 대상 서버의 IP 주소를 IP 헤더의 수신처에 기록
- IP는 수신처가 어느 방향에 있는지 조사하여 그 방향에 있는 다음 라우터를 조사
- 거기에 패킷을 도착하도록 이더넷에 의뢰하고, 다음 라우터에 할당된 이더넷의 주소(MAC주소)를 조사하고 MAC 헤더에 기록
- 이렇게 해서 패킷 송신하여 허브에 도착(--> 위 그림 1번에 해당)
- 허브에는 패킷의 목적지를 판단하기 위한 표와 이더넷 헤더의 수신처 정보를 결합하여 패킷의 목적지를 판단하여 중계  
  (허브가 여러개이면, 순차적으로 허브를 경유)
- 패킷은 라우터에 도착(--> 위 그림 2번에 해당)
- 라우터의 IP용 표와 IP 헤더의 수신처와 결합하여 어느 라우터에 패킷을 중계할 것인지 알아냄 
- 다음 라우터에 패킷을 건네주기 위해 라우터의 MAC 주소하고, MAC 헤더에 저장  
  (IP 주소는 그대로, MAC 헤더를 바꿈) --> 위 그림 3번에 해당
- 이것을 반복하면, 패킷은 목적지에 도달
- 이더넷과 IP가 역할을 분담하는데, 이더넷 부분은 무선 LAN, ADSL, FTTH 등 IP의 의뢰를 받아 패킷을 운반할 수 있는 것이면 가능
- 이더넷과 같은 거대한 네트워크를 구축하려면 이러한 유연성이 필요한데, 이것이 역할을 분담하는 이유

#### 패킷 송.수신 동작의 개요 
![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_11.png)

- 다음은 IP 담당 부분의 패킷 송.수신 동작
- IP 담당 부분은 패킷을 상대에게 송출만 하고, 그 뒤에 상대가 있는 곳까지 패킷을 운반하는 것은 허브나 라우터가 수행
- IP 담당 부분은 패킷을 운반하는 동작 전체에서 입구 부분에 불과함
- ① 송신
  - TCP 담당 부분이 TCP 헤더를 데이터에 붙여 IP 담당 부분에 패킷 송신 의뢰하여 건네줌
  - TCP 헤더는 IP 주소를 나타냄
  - 의뢰를 받은 IP 담당 부분은 MAC 헤더를 부가함  
    MAC 헤더는 이더넷 등의 LAN을 사용하여 가장 가까운 라우터까지 패킷을 운반할 때 사용하는 제어 정보 기록
- ② 송신
  - 만든 패킷을 네트워크용 하드웨어에 건네줌  
    하드웨어는 이더넷이나 무선 LAN 등을 말함
  - LAN 어댑터에 건네줄 때의 패킷의 모습은 0, 1 비트가 이어져있는 데이터  
  - 신호는 허브나 라우터 등의 중계 장치에 도착하고, 중계 장치가 상대가 있는 곳까지 패킷을 전달
- ③ 수신
  - 케이블에서 신호의 모습을 한 패킷이 들어오면, 이것을 LAN 어댑터에서 디지털 데이터의 모습으로 되돌림
  - 디지털 데이터를 IP 담당 부분에게 건네줌 
- ④ 수신
  - IP 담당 부분이 MAC 헤더와 IP 헤더 뒤에 이어지는 데이터 조각을 TCP 담당 부분에게 전달
- <b>IP 패킷 송수신 동작은 패킷의 역할에 관계없이 모두 같음</b>  
  TCP 헤더와 데이터 조각을 한 덩어리의 바이너리 데이터로 간주하여 내용을 보지않기 때문

#### 수신처 IP 주소를 기록한 헤더를 만든다
- IP 헤더에서 가장 중요한 것은 수신처 IP 주소
- TCP 담당 부분에서 통지된 통신 상대의 IP 주소를 설정  
  이 IP 주소는 본래 애플리케이션에서 통지된 통신 상대의 IP 주소임
- 송신처 IP 주소도 설정하는데, 이는 통신 상대의 주소를 설정  
  송신처 IP 주소는 송신처가 되는 LAN 어댑터를 판단하여 주소 설정
- 패킷을 건네줄 상대를 판단하는 방법은 라우터가 IP용 표를 사용하여 다음 라우터를 결정하는 동작과 같음  
 이 IP용 표를 경로표라고 함
- 예를 들어 수신처 IP 주소가 192.168.1.21 이면 192.168.1와 일치하는 행을 찾아내고,   
  오른쪽부터 두 번째와 세 번째 항목을 조사함
  - 오른쪽에서 두 번째 Interface 항목은 LAN 어댑터 등의 네트워크용 인터페이스를 나타냄  
    인터페이스에서 패킷을 송신하면 상대에 패킷을 전해줄 수 있다는 의미
  - 오른쪽에서 세 번째 Gateway 항목은 다음 라우터의 IP 주소를 기록하게 되어 있음  
    IP 주소를 가진 라우터에 패킷을 건네주면 라우터가 목적지에 패킷을 중계해 준다는 것을 의미함
- 경로표의 맨 위 행은 목적지와 넷마스크가 0.0.0.0으로 등록되어 있음  
  이것은 소위 기본 게이트웨이를 나타내며, 다른 곳에 일치하는 것이 없으면 이 행이 해당하는 것으로 간주
- 이렇게 해서 어느 LAN 어댑터에서 패킷을 송신해야 하는지 알고 나서 LAN 어댑터에 할당되어 있는 IP 주소를 IP 헤더으티 송신처 IP 주소로 설정
- <b>프로토콜 번호</b>라는 필드 값도 설정하는데, 이는 패킷에 들어간 내용물이 어디에서 의뢰받은 것인지를 나타냄

#### 이더넷용 MAC 헤더를 만든다
- IP 헤더 제작 후, IP 담당 부분 앞에  MAC 헤더를 붙임
- 이더넷에서는 TCP/IP 개념이 통용되지 않으며 이더넷의 수신처 판단 구조로 사용하는 것이 MAC 헤더임
- MAC 헤더의 맨 앞에 있는 수신처 MAC 주소와 그 다음의 송신처 MAC 주소는 각각 패킷을 전달하는 상대와 패킷을 송신한 송신처의 MAC 주소를 나타냄
- MAC 주소는 48 비트(IP 주소는 32비트)
- IP 주소는 00동 00번지의 일종의 그룹화 개념이지만, MAC 주소는 그런 개념이 없음 
- <b>3개의 이더타입</b>이라는 항목은 내용물이 무엇인지를 나타내며, 이더넷의 내용물은 IP나 ARP라는 프로토콜의 소켓임
  - 이더타입 필드 : IP 프로토콜을 나타내는 0800 이라는 값 설정
  - 송신처 MAC 주소 : 자체의 LAN 어댑터의 MAC 주소 설정. 어댑터 제조시 그 안에 있는 ROM에 기록됨
  - 수신처 MAC 주소 : 패킷을 건네주는 상대편 MAC 주소. 이는 경로표에 기록되어 있으며 경로표에서 찾은   
    일치하는 행의 Gateway 항목에 기록되어 있는 IP 주소의 기기가 패킷을 건내주는 상대가 됨
- 이 시점에서 상대의 MAC 주소는 모르기 때문에 IP 주소에서 MAC 주소를 조사하는 동작 실행

#### ARP로 수신처 라우터의 MAC 주소를 조사한다
- MAC 주소를 동작하는 실행에서 ARP(Address Resolution Protocol) 를 사용
- 이더넷에는 연결되어 있는 전원에게 패킷을 전달하는 브로드캐스트라는 구조가 있음  
- 상대가 자신과 같은 네트워크에 존재하면 이것으로 MAC 주소를 알 수 있음  
  그러면 MAC 주소를 MAC 헤더에 설정하여 MAC 헤더를 만듬
- 패킷을 보낼 때마다 이 동작을 수행하면 ARP의 패킷이 불어나기 때문에 한 번 조사한 결과는 ARP 캐시라는 메모리 영역에 보존하여 이용
- ARP 캐시에 저장된 MAC 주소를 언제까지나 계속 사용하면 문제가 발생할 수 있으므로,  
  이를 막기위해 ARP 캐시에 저장된 값은 시간이 되면 삭제하게 되어 있음. 보통 몇 분정도임
- 수신한 패킷을 그대로 IP 담당 부분에 건네주면 단순이 수신만 하면 되므로 IP 이외의 특수한 패킷에도 대응할 수 있음

#### 이더넷의 기본
![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_12.png)
- <b>이더넷</b>은 다수의 컴퓨터가 여러 상대와 자유롭게 적은 비용으로 통신하기 위해 고안된 통신 기술
- 네트워크의 실체는 케이블만 있으며, 트랜시버도 결국 신호를 흐르게하는 케이블임
- 한 대가 신호를 보내면 전원에게 신호가 도착함  
  신호의 맨 앞부분에 누구에게 갈 것인지를 나타내는 정보, 즉 수신처 주소를 써둠
- 최종적으로는 윗 그림의 (c)와 같이 스위칭 허브를 사용한 형태가 보급되었는데, 현재는 이더넷이라고 말하면 이 형태를 의미함  
- 수신처 MAC 주소로 나타내는 원하는 기기가 존재하는 부분에만 신호가 흐르고, 다른 곳에는 신호가 흐르지 않게 된 것 
- 이더넷도 IP와 마찬가지로 패킷의 내용물은 보지 않으므로 이더넷의 송.수신 동작은 TCP 동작 단계에 상관 없이 모든 것에 공통

#### IP 패킷을 전기나 빛의 신호로 변환하여 송신한다
- 디지털 데이터를 전기나 빛의 신호로 변환하여 네트워크의 케이블에 송출하는데, 이것이 송.수신 동작의 본질
- 이 동작을 실행하는 것이 LAN 어댑터이며, LAN 어댑터를 제어하려면 LAN 드라이버 소프트웨어가 필요  
  이는 기본적으로 OS에 첨부되어 있음
- LAN 어댑터는 전원을 공급하면 즉시 사용할 수 있는 것이 아니라, 초기화 과정이 필요  
  이더넷 특유의 작업으로 이더넷의 송.수신 동작을 제어하는 MAC 회로에 MAC 주소를 설정 
- LAN 어댑터의 ROM에는 전 세계적으로 중복되지 않도록 일원화해서 관리하는 MAC 주소 제조시 기록하므로, 이것을 읽어와서 MAC 회로에 설정함
- LAN 어댑터에 기록된 MAC 주소는 LAN 드라이버가 MAC 회로에 설정

#### LAN 어댑터 내부 구조
![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_13.png)


#### 패킷에 3개의 제어용 데이터를 추가한다
![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_14.png)

- 패킷을 전기 신호로 변환하여 실제로 케이블에 송출하는 MAC 회로 작업이 수행됨
- LAN 드라이버는 IP 담당 부분에서 패킷을 받으면 이를 LAN 어댑터의 버퍼 메모리에 복사 후, 이를 패킷을 송신하도록 MAC 회로에 명령을 보냄
- MAC 회로는 송신 패킷을 버퍼 메모리로부터 추출하고 맨 앞에는 <b>프리앰블</b>과 <b>스타트 프레임 딜리미터</b>라는 두 개의 데이터. 맨 끝에는 <b>프레임 체크 시퀀스(FCS)</b>라는 오류 검출용 데이터를 부가
- 프리엠블은 송신하는 패킷을 읽을 때의 타이밍을 잡기 위한 것으로, 1010.. 과 같이 1과 0이 번갈아 나타난 비트열이 56비트 이어진 것
- 디지털 데이터를 전기 신호로 나타낼 때는 0과 1의 비트 값을 전압이나 전류 값에 대응시킴
- 실제 신호에는 각 비트의 구분을 나타내는 보조선이 있으므로 각 비트의 구분이 어디까지인지 판단하면서 전압이나 전류의 값을 읽어야 함
- 1과 0이 이어지면 신호의 변화가 없어져서 비트 구분을 판단할 수 없게 된다는 문제가 생김  
  이를 해결하기 위해 <b>클록</b>이라는 신호와 데이터 신호와 결합하여 수신측으로 보냄
- 수신한 신호(c)에서 클록 신호 (b)로 타이밍을 잡으면, 데이터 신호(a)에서 비트 값을 읽을 수 있음
- 이때 클록 신호의 타이밍을 판단하는 것이 중요한데, 이는 패킷 앞에 프리앰블의 역할
- 이더넷에는 속도나 케이블의 종류에 따라 다수의 파생 방식이 있으며, 이 방식에 따라 신호의 모습이 달라짐  
  1010101... 이라는 디지털 값을 전기 신호로 바꾼 프리앰블의 파형이 반드시 일정하게 되는 것이 아님 
- 스타트 프레임 딜리미티(SFD)는 패킷의 시작을 나타내는 표시가 됨  
  (마지막 비트 패턴이 다르기 때문에 프리앰블과 구분 가능)
- 끝에 부가하는 FCS(Frame check sequence)는 데이터가 변한 경우의 검출 용도로 사용  
  데이터의 값이 1비트라도 변화하면 계산한 결과도 달라진 값을 취하도록 고안되어 있음

#### 허브를 향해 패킷을 송신한다
- 앞서 프리앰블, 스타트 프레임 딜리미터, FCS 이 세가지를 부여하면 케이블에 송출하는 패킷이 완성
- 다음으로는 패킷을 송신하는데,  리피터 허브를 사용했을 때  반이중 통신과 전이중 통신이 있음
  - 반이중 모드: 특정 시점에 송신과 수신 중 하나만 가능한 모드
  - 전이중 모드: 송신 동작과 수신 동작을 동시에 수행할 수 있는 모드
- 반이중 모드 동작 설명
  - 케이블에 다른 기기가 송신한 신호가 흐르고 있는지 조사
  - 신호가 흐르고 있지 않으면 송신 동작 실행
  - 송신 동작은 먼저 MAC 회로가 프리앰블의 맨 앞부터 1비트씩 차례로 디지털 데이터를 전기 신호로 변환
  - 전기 신호를 PHY 또는 MAU라는 송.수신 신호로 전달 
- 디지털 데이터를 신호로 변환하는 속도가 전송 속도임  
  1초 동안 10Mb 분량의 디지털 데이터를 신호로 변환하여 보내는 것이 10메가비트/초라는 전송률임
- PHY(MAU) 회로는 MAC 회로가 송신한 신호의 형식을 변환하기 위한 변환 회로
- PHY 회로가 MAC 회로에서 받은 신호를 케이블에 송신할 때 단지 송신 동작만 실행하는 것이 아니라 수신 신호선에서 신호가 흘러들어오는지 감시
- 이더넷이라는 통신 방식은 송신한 신호가 상대에게 완전히 도착했는지 확인하지 않음  
  오류가 발생해도 프로토콜 스택의 TCP가 검출하므로 신호를 송신할 때 오류를 확인할 필요가 없음
- 동시에 송신 동작에 들어간 경우, 이를 충돌이라고 하며 이 때 송신 동작을 중지함
- 충돌이 일어난 사실을 다른 기기에 알리기 위해 재밍(, jam) 신호라는 특수한 신호를 잠시 흘리고 나서  
  손신 동작을 멈추고 잠시 기다렸다가 다시 한 번 송신 동작을 시도함
- 다시 송신 동작 시도시, 난수를 생성하여 각각 대기 시간을 랜덤하게 만들어 계산 후 재시도
- 10번 이상 해도 충돌시 오류로 판단

#### 돌아온 패킷을 받는다
- 패킷을 수신할 때의 동작을 설명 
- 리피터 허브를 이용한 반이중 동작의 이더넷에는 1대가 송신한 신호가 리피터 허브에 접속된 케이블 전부에 흘러들어감
- 수신 동작은 이러한 신호를 전부 받아드리는 것부터 시작함
- 신호의 맨 앞에 프리앰블을 통해 파형에서 타이밍을 계산하여 스타트 프레임 딜리미터가 나오면 그 다음 비트부터 디지털 데이터로 변환하여 동작 개시
- PHY(MAU) -> MAC 회로쪽으로 이동함
- PHY(MAU) 회로에서 신호를 공통 형식으로 변환하여 MAC 회로에 보냄 
- MAC 회로에서 신호를 맨 앞부터 차례대로 디지털 데이터로 변환하여 버퍼 메모리에 저장
- 신호의 마지막에 이르러 FCS를 검사
- MAC 헤더의 수신처 MAC 주소를 조사하여 LAN 어댑터를 초기화할 때 설정한 자체의 MAC 주소와 비교 후 이것이 자신에게 오는 것인지 판단
- 자신의 오는 경우에만 버퍼 메모리에 저장하고 MAC 회로가 할 일이 끝나면 패킷을 수신한 사실을 컴퓨터 본체에 통지
- 컴퓨터에 통지시 <b>인터럽트</b>라는 구조를 사용하는데, 컴퓨터 본체가 실행하고 있는 작업에 끼어들어 LAN 어댑터 쪽에 주의시키는 것을 말함
- 인터럽트 수행 동작 순서
  - LAN 어댑터가 확장 버스 슬롯 부분에 있는 인터럽트용 신호선에 신호를 보냄
  - 신호선은 컴퓨터 본체측의 인터럽트 컨트롤러를 통해 CPU에 연결되어 있음
  - CPU는 실행하고 있던 작업을 일시 보류하고 OS 내부의 인터럽트 처리용 프로그램 쪽으로 전환
- 인터럽트에 의해 LAN 어댑터의 버퍼 메모리에서 수신한 패킷을 추출하면, LAN 드라이버는 MAC 헤더의 타입 필드의 값으로부터 프로토콜을 판별
- LAN 드라이버는 어디서 패킷이 왔는지는 신경쓰지 않고, 파입 필드의 값에 대응하는 프로토콜 스택에 패킷을 건네주기만 함

#### 서버의 응답 패킷을 IP에서 TCP로 넘긴다
- 웹서버에서 패킷이 돌아온 것으로 간주하고 다음 프로토콜 스택의 동작을 추적해보자
- 서버에서 반송된 패킷의 타입은 0800이므로 LAN 드라이버는 TCP/IP의 프로토콜 스택에 패킷을 건넬 것임
- IP 담당 부분은 IP 헤더 부분부터 조사하여 포캣에 문제가 없는지 확인하고, 수신처 IP 주소를 조사함
- IP 헤더 부분의 수신처 IP 주소와 실제 클라이언트의 IP 주소와 다르면 오류가 있는 것임  
  오류 발생시, <b>ICMP</b>라는 메세지를 통신하여 통신 상대에게 오류를 통지함
- IP 프로토콜에는 조각 나누기(fregmentation) 라는 기능이 있는데, 수신한 패킷이 분할된 것이라면 IP 담당 부분 내부의 메모리에 일시적으로 보관됨
- IP 헤더에 있는 <b>플래그</b>라는 항목을 보면 알 수 있으므로, 이를 통해 확인 후, 분할된 것이면 메모리에 일시적으로 보관
- IP 헤더에 있는 ID 정보에 같은 값을 가진 패킷이 도착하기를 기다리고, 분할된 패킷은 ID 정보의 값이 모두 같음
- <b>프래그먼트 오프셋</b>이라는 항목에는 패킷 조각 순서가 저장되어 있음
- 패킷을 원래 모습으로 되돌리는 것이 <b>리어셈블링(reassembling)</b> 이라고 함
- 위의 작업이 끝나면 패킷은 TCP 담당 부분에게 전달
- TCP 담당 부분은 IP 헤더에 기록된 수신처 IP 주소와 송신처 IP 주소, TCP 헤더에 기록된 port 번호, 송신처 포트 번호의 4가지 항목을 조사하여 해당 소켓을 찾음

### UDP 프로토콜 송수신 동작
#### 수정 송신이 필요없는 데이터의 송신은 UDP가 효율적이다
- TCP의 동작은 상당히 복잡한데, 그 이유는 데이터를 확실하면서도 효율적으로 전달하기 위해서임
- 이를 가장 간단히 실현하는 방법은 데이터를 '전부' 보낸 후에 수신측에서 수신 확인 응답을 받는 방법  
  만약 도착하지 않은 경우 다시 보내면 됨
- 어떤 상황에서는 TCP처럼 복잡한 구조를 사용하지 않아도 효율적으로 데이터를 다시 보낼 수 있음  
  이는 <b>데이터가 한 개인 패킷에 수용할 수 있을 만큼 길이가 짧은 경우</b>
- 패킷이 한개밖에 없다면 이것이 없어졌는지 생각할 필요가 없지만, 데이터를 전부 다시 보낸다 해도 패킷을 한 개만 보내면 되므로, 낭비가 아님

#### 제어용 짧은 데이터
- DNS 서버에 대한 조회 등 제어용으로 실행하는 정보 교환은 한 개의 패킷으로 끝나는 경우가 많으므로 TCP대신 UDP 사용
- 애플리케이션에서 송신 데이터를 받으면 여기에 UDP 헤더를 부가하고 이것을 IP에 의뢰하여 송신하기만 함
- 수신도 간단한데, IP 헤더에 기록되어 있는 수신처 IP 주소, 송신처 IP 주소, UDP 헤더에 기록되어 있는 수신처 포트 번호, 송신처 포트 번호라는 네 항목과 소켓에 기록된 정보 결합하여 데이터를 건네줄 대상 애플리케이션을 판단하고 여기에 데이터를 건네주기만 함
- 오류가 발생해도 프로토콜 스택은 신경쓰지 않지만 문제가 없음  
  오류가 발생하면 회답이 돌아오지 않으므로 애플리케이션이 이 사실을 알아차리고 데이터를 한 번 더 다시 보냄

#### 음성 및 동영상 데이터
- 음성이나 영상의 데이터를 보낼 때도 UDP를 사용
- 음성이나 영상 데이터는 결정된 시간 안에 데이터를 건네주어야 함. 데이터의 도착이 지연되면 이것을 재생하는 타이밍이 맞지 않음
- 데이터의 도착이 지연되면 재생하는 타이밍이 맞지 않아 다시 보내도 재생 타이밍이 맞지 않음
- 음성이나 영상에는 데이터가 다소 없어도 치명적인 문제가 되지 않은 성질이 있어, 단순히 UDP로 데이터를 보내는 것이 더 효율적임

## 용어 정리
- Gateway
  - TCP/IP 세계에서 라우터를 가리키는 용어 