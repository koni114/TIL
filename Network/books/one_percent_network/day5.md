## chatper03 - 케이블의 앞은 LAN 기기였다 - 허브와 스위치, 라우터의 탐험
- 케이블에 송출한 패킷이 리피터 허브, 스위칭 허브, 라우터 등의 네트워크 기기를 경유하여 인터넷을 향해 진행하는 부분 

### 케이블과 리피터, 허브 속을 신호가 흘러간다
#### 하나하나의 패킷이 독립된 것으로 동작한다
- 컴퓨터에서 송신된 패킷은 허브나 라우터라는 중계 장치에 의해 중계되어 목적지를 향해 진행
- 패킷의 헤더에 기록된 제어 정보와 중계 장치 내부에 있는 중계 대상을 등록한 표로 목적지를 판단하고 목적지에 가까워지도록 하여 패킷을 중계한다는 형태
- 내용을 보지 않으므로, 애플리케이션의 데이터나 TCP 프로토콜 제어 정보의 내용이 패킷을 운반하는 동작에 영향을 주지 않음
- 이번 장에서는 클라이언트 PC가 송신한 패킷이 리피터 허브 -> 스위칭 허브 -> 라우터를 경유하여 인터넷에 나가는 것으로 간주

#### LAN 케이블은 신호를 약화시키지 않는 것이 핵심이다
![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_15.png)
![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_16.png)

- LAN 어댑터의 PHY(MAU) 회로에서 전기 신호로 형태를 바꾼 패킷은 RJ-45 커넥터를 통해 <b>트위스트 페어 케이블(꼰 선쌍)</b> 에 들어감
- 이더넷의 신호의 실체는 플러스와 마이너스의 전압이므로 LAN 어댑터의 PHY(MAU) 회로의 플러스와 마이너스 신호 단자에서 신호가 나온다고 생각하면 됨
- LAN 어댑터의 PHY(MAU) 회로는 커넥터의 1번, 2번 핀에서 케이블로 신호가 흘러나감
- 신호는 케이블 속을 흘러 리피터 허브의 커넥터 부분에 도착
- 송출한 신호는 허브에 도착시 신호가 약해져있으며, 케이블의 길이가 더 길어질수록 신호가 약해짐

![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_17.png)

- 위의 그림처럼 사각형의 각진 신호를 사용하지만, 이 각이 뭉개져서 둥글게 됨
- 이 현상은 주파수가 높을수록 에너지가 떨어지는 비율이 높다는 전기 신호의 성질과 관계가 있음
- 약해진 신호가 변형되면 0과 1을 잘못 판독할 수 있는데, 이는 통신 오류의 원인이 됨

#### '꼼'은 잡음을 방지하기 위한 방법이다
- LAN 케이블로 사용하는 트위스트 페어 케이블(꼰 선쌍)은 잡음의 영향을 억제하는 대책이 마련되어 있는데, 이것이 '꼼'임
- 잡음의 원인은 주변에서 생기는 전자파임  
  이 때문에 케이블의 주위에 전자파가 있으면 신호와는 다른 전류가 케이블 안에 흐름
- 케이블에 영향을 주는 전자파는 크게 2가지
  - 모터, 형광등, 모니터 등에서 누설되는 전자파(외부에서 발생)
  - 케이블 안의 인접한 신호선에서 누설되는 전자파
- 이 두가지를 선을 꼼으로서 막을 수 있음

#### 리피터 허브는 연결되어 있는 전체 케이블에 신호를 송신한다
- 신호가 리피터 허브에 도착하면 LAN 전체에 신호가 흩어짐
- 이더넷의 기본이라는 원리, 즉 전체에 패킷의 신호를 뿌리고 수신처 MAC 주소에 해당하는 기기만 패킷을 수신한다는 원리를 그대로 실현한 것이 리피터 허브임
- 리피터 허브의 커넥터 안쪽에는 LAN 어댑터의 내부에 있는 PHY(MAU) 회로와 역할이 같은 회로가 있음
- 제대로 수신하려면 송신 단자에서 보낸 신호를 수신 단자가 받도록 해야하며, 이 때문에 허브 안의 PHY 회로와 커넥터 사이의 신호선을 교차시킴
- 리피터 허브의 끝의 커넥터에는 MDI/MDI-X와 같이 쓰여있는 전환 스위치가 붙어있음
- MDI로 전환하는 스위치가 없고 모든 커넥터가 MDI-X인 경우에는 크로스 케이블로 허브들을 접속
- 리피터 회로의 기본은 신호를 그대로 뿌리는 것이므로 잡음의 영향을 받아 변형되고, 데이터가 변화한 것 같은 신호라도 그대로 흘려버림

#### 스위칭 허브는 주소 테이블로 중계한다
- 스위칭 허브(=스위치)는 이더넷의 패킷을 그대로 목적지를 향해(특정 port) 중계하도록 만들어져 있음

![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_18.png)

- 스위칭 허브 송수신 프로세스 
  - 신호가 들어옴 
  - PHY(MAU) 회로 수신 부분으로 들어감 
  - MAC 회로 
  - 버퍼 메모리 저장
  - MAC 주소표 조사하여 송신할 MAC 주소 조사
  - 스위치 회로를 경유하여 송신측의 포트로 보냄
  - MAC 회로 -> PHY(MAU) -> 송신 
- 커넥터와 안쪽에 있는 스위치 회로 부분을 포트라고 부르므로, 스위칭 허브의 각 포트는 PC 의 LAN 어댑터와 거의 같음
- LAN 어댑터와 달리 스위칭 허브의 포트에는 MAC 주소가 할당되어 있지 않고, MAC 주소표를 통해 송신할 MAC 주소를 확인

#### MAC 주소 테이블을 등록 및 갱신한다
- 스위칭 허브는 패킷을 중계할 때 MAC 주소표의 내용을 갱신하는 동작도 실행
- 하나의 방법은 페킷을 수신했을 때 송신처 MAC 주소를 조사하고, 이것을 수신한 입력 포트 번호와 하나의 세트로 MAC 주소표에 등록하는 것
- 사용하지 않고 일정시간이 경과한 경우는 MAC 주소표에서 삭제
- 예외 경우
  - 주소표에 등록된 수신 포트와 송신 포트가 동일할 때는 폐기  
    ex) 리피터 허브에서 브로드캐스팅을 통해 스위칭 허브에 송신되고, 다시 스위칭 허브에서 리피터 허브로 송신되는 경우
  - 수신처 MAC 주소와 일치하는 주소가 등록되어 있지 않은 경우, 수신받은 포트 이외에 모든 포트에 전송
  - 수신처 MAC 주소가 브로드캐스트 주소인 경우에도 수신 포트를 제외하고 모든 포트에서 패킷을 송신

#### 전이중 모드에서 송신과 수신을 동시에 실행한다
![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_19.png)

- 전이중 모드는 송신과 수신을 동시에 실행할 수 있는 성질인데, 이는 리피터 허브에는 없고 스위치 허브에만 있는 특징
- 스위칭 허브의 포트 부분, PHY 회로, MAC 회로의 내부도 송신과 수신이 나뉘어져 있어 신호가 따로 흐르기 때문에 충돌하지 않음
- 신호의 충돌을 검사하는 회로를 무효화하기로 한 것이 전이중 동작 모드 

#### 최적의 전송 속도로 보내는 자동 조정
- 자동 조정(auto negotiation)은 접속한 상대가 전이중 모드를 지원하는지 검출하고 동작 모드를 자동으로 전환하는 기능
- 동작 모드뿐만 아니라 상대의 전송 속도를 검출하여 전송 속도도 자동으로 전환됨
- 데이터가 흐르고 있지 않을 때 링크 펄스를 통해 조정 가능 여부를 상대방에게 보내서 자동 조정

#### 스위칭 허브는 복수의 중계 동작을 동시에 실행한다
- 스위칭 허브는 수신처 MAC 주소의 기기가 존재하는 포트 이외에는 송신 동작을 실행하지 않으므로 다른 포트는 빈상태가 됨
- 이렇게 해서 동시에 여러 패킷을 중계할 수 있음

### 라우터의 패킷 중계 동작
#### 라우터의 기본
- 라우터의 기본은 중계 대상이 등록된 표를 보고 패킷을 어디에 중계해야할지 판단하는 부분은 스위칭 허브와 비슷
- 라우터의 바탕이되는 IP라는 개념이 스위칭 허브의 바탕이되는 이더넷과 다름
- 라우터의 내부 구조는 중계 부분과 포트 부분으로 나뉨
  - 중계 부분: 패킷의 중계 동작을 판단하는 부분
  - 포트 부분: 패킷을 송.수신 
- 중계 부분은 IP 담당 부분과 같고, 포트 부분은 LAN 어댑터와 같다고 생각하면 됨
- 라우터의 포트 부분에 무선 LAN용 하드웨어를 장착한 기종이라면 무선 LAN도 지원 가능  
  또한 LAN 이외의 통신 기술도 지원하는데,  ADSL, FTTH 등 
- 포트 부분에서 패킷 수신시, 포트 부분의 통신 기술의 규칙을 따름  
  ex) 무선 LAN, 이더넷 규칙 등
- <b>라우터의 각 포트에는 MAC 주소와 IP 주소가 할당되어 있음</b> 반대로 스위칭 허브는 돌아운 패킷을 전송만하며,  
  허브 자체가 송신처나 수신처가 되지 않음

#### 경로표에 등록된 정보
![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_20.png)
- 라우터는 IP 주소로 중계 대상을 판단. 즉 경로표에는 IP 주소가 매핑되어 있음
- 라우터의 테이블은 <b>라우팅 테이블</b>, 또는 <b>경로표</b> 라고 부름
- 위 그림의 맨 왼쪽의 항목은 수신처가 들어가 있으며, 서브넷 자체를 나타내는 주소가 들어가 있음  
  (서브넷 --> 네트워크 주소만 들어가 있고, 호스트 주소는 0인 값)
- 네트워크 번호의 비트 수를 판단하기 위해서 경로표에는 넷마스크 항목도 있음
- 라우터는 호스트 번호를 무시하고 네트워크 번호 부분만 조사함 
- 실제로 서브넷에 할당된 넷마스크의 값과 경로표의 등록된 넷마스크의 값이 다를 수 있는데,  
  그 이유는 <b>주소 집약의 개념이 들어가 있기 때문</b>
- 주소 집약은 몇 개의 서브넷을 모아 하나의 서브넷으로 간주한 후 서브넷을 경로표에 등록하는 방법으로, 이렇게 하면 등록 건 수를 줄일 수 있음
- 넷마스크를 255.255.255.255, 즉 32비트를 전부 1로 만들면 개별 컴퓨터를 나타내는 주소를 수신처 항목에 등록 가능
- 위의 그림에서 게이트웨이와 인터페이스(=포트) 항목은 패킷의 중계 대상을 나타냄
- <b>수신처 항목과 넷마스크 항목에서 해당 행을 나타내면 '인터페이스' 항목에 등록되어 있는 인터페이스(포트)에서 게이트웨이 항목에 등록되어 있는 IP 주소를 가진 라우터에 대해 패킷을 중계</b>
- 매트릭은 수신처 IP 주소에 기록되어 있는 목적지가 가까운지, 먼지를 나타냄. 숫자가 크면 멀고 작으면 가까움
- 스위칭 허브는 패킷 중계 동작의 일환으로 MAC 주소 테이블에 정보를 등록하는 동작 실행  
  라우터는 경로표에 경로 정보를 등록하거나 갱신하는 동작은 패킷을 중계하는 동작과 분리되어 있음
- 마지막 행은 중계 대상을 모두 등록한 역할을 수행

#### 라우터 경로표 등록 방법
- 사람이 수동으로 경로 정보를 등록/갱신
- 라우팅 프로토콜이라는 구조를 사용하여 라우터들끼리 경로 정보를 교환하고 라우터가 자체에서 경로표 등록  
  (라우팅 프로토콜은 여러개가 존재. ex. RIP, OSPF, BGP)

#### 라우터의 패킷 수신 동작
- 라우터의 포트는 여러 변형이 있지만, 여기서는 이더넷의 포트에서의 패킷 수신 동작에 초점을 맞추어 설명
- 패킷을 수신하여 버퍼 메모리에 저장하는 부분까지의 동작도 LAN 어댑터와 거의 같음
- 라우터의 포트에는 MAC 주소가 할당되어 있으며, 라우터는 자신의 주소에 해당하는 패킷만 수신하고 해당하지 않는 패킷을 폐기

#### 경로표를 검색하여 출력 포트를 발견한다
- 라우터는 패킷 수신 동작이 끝나면 맨 앞의 MAC 헤더를 폐기. MAC 헤더는 라우터에 패킷을 건네주는 역할이기 때문
- <b>라우터에서 중계하는 패킷의 수신처 MAC 주소에는 라우터 포트에 할당된 MAC 주소가 기록되어 있음</b>
- MAC 헤더 뒤에 있는 IP 헤더의 내용을 보고 패킷 중계 동작에 들어감
  - '1 경로표에서 중계 대상 조사
  - '2 수신한 패킷의 수신처 IP 주소와 경로표의 '수신처' 항목을 조사하여 해당하는 행을 찾음  
  - '3 넷마스크 항목에 등록된 값에서 네트워크 번호의 비트 수를 판단하여 네트워크 번호 부분만 비교
  - '4 복수의 후보가 발생하는 경우
    - '4.1 네트워크 번호의 비트 수가 가장 긴 것을 찾음  
      why? 비트 수가 가장 긴 것(= 최장 일치)이 가장 범위가 축소된 것이기 때문
    - '4.2 네트워크 번호의 비트 수가 같은 경우  
      - 매트릭 값이 가장 작은 것을 찾음
  - '5. 행이 한 개도 발견되지 않는 경우
    - 이 경우 라우터는 패킷을 폐기하고 ICMP 메세지로 송신처에 이 사실을 통보
- <b>행이 한 개도 발생하지 않은 경우 폐기하는 이유</b>
  - 스위칭 허브는 많아야 수 천대 정도이기 때문에 브로드캐스팅해도 큰 문제가 발생하지 않지만,  
    라우터는 엄청난 규모이므로, 대량에 패킷이 뿌려지는 경우 네트워크 혼잡이 발생하므로 중계 대상이 명확하지 않으면 폐기 함 

#### 헤딩하는 경로가 없는 경우에 선택하는 기본 경로
- 마지막 1행이 중계 대상을 모두 등록한 것과 같은 역할 수행
- 넷마스크가 0.0.0.0으로 되어 있는데, 이는 비교동작을 실행하지 않아도 된다는 의미
- <b>이 행을 기본 경로라고 하며, 여기에 등록된 라우터를  기본 게이트웨이라고 함</b>

#### 패킷은 유효기간이 있다
- 패킷이 뱅글뱅글 도는 현상을 막기 위하여 TTL(Time To Live, 생존 기간)이라는 IP 헤더의 필드를 갱신함  
  이 값이 0이되면 폐기

#### 큰 패킷은 조각 나누기 기능으로 분할한다
- 라우터의 포트 부분의 회선의 LAN의 종류에 따라 패킷의 최대 길이가 달라짐
- 출력 포트측의 패킷의 최대 길이가 입력측보다 작은 경우도 있음  
- IP 프로토콜의 규정된 조각 나누기(fragmentation)라는 방법을 사용하여 패킷을 분할  
- 조각 나누기는 TCP 데이터 분할과 다른데, TCP 데이터 분할은 패킷 저장 전에 데이터를 분할하며, 조각 나누기는  
  패킷이 만들어진 후에 패킷을 분할하는 것을 말함

#### 라우터의 송신 동작은 컴퓨터와 같다
- 송신 동작은 출력측의 포트에 따라 다름  
  이번 장에서는 출력측의 포트가 이더넷인 경우 송신 동작 설명
- 패킷 송신 동작은 기본 프로토콜 스택의 IP 담당 부분이 패킷을 보낼 때와 같음
- 라우터가 다음에 건네줄 상대를 판단하는 방법
  - 경로표의 '게이트웨이' 헝목에 IP 주소가 쓰여있응면 IP 주소가 건네줄 상대
  - 경로표의 '게이트웨이' 항목이 공란이면 IP 헤더의 수신처 IP 주소가 건네줄 상대
- 라우터도 ARP를 사용하여 다음의 건네줄 상대의 MAC 주소를 조사

#### 라우터와 스위칭 허브의 관계
- 통신 상대까지 패킷을 전달하는 전체의 동작은 IP(라우터)가 담당하고, 이 동작을 할 때  다음 라우터까지 패킷을 운반하는 부분은 이더넷(스위칭 허브)이 담당

### 라우터의 부가 기능
#### 주소 변환으로 IP 주소를 효율적으로 이용한다
- 라우터는 중요한 두 가지 기능인 <b>주소 변환</b>과 <b>패킷 필터링</b>이 있음
- 주소 변환은 private 주소를 할당받은 사내 네트워크와 인터넷과 직접 패킷을 주고 받지 않게 하도록 특별한 구조를 사용하여 접속하는 것을 말함
- private address는 IP 수요가 증가함에 따라 부족 현상을 해결하기 위하여 특정 주소를 사내용으로 사용한다는 규칙을 세웠는데, 이를 <b>private address</b>로 하고, 이전의 인터넷과 실제 통신하는 고유 주소를 public address(global address)라고 함
- private address는 아래 범위로 한정
  - 10.0.0.0 ~ 10.255.255.255
  - 172.16.0.0 ~ 172.31.255.255
  - 192.168.0.0 ~ 192.168.255.255
- 사내 네트워크를 인터넷에 접속할 때는 다음과 같이 구성해야 함 
![img](https://github.com/koni114/TIL/blob/master/Network/lecture/one_percent_network/img/network_21.png)

#### 주소 변환의 기본 동작
- 주소 변환의 구조는 패킷을 중계할 때 IP 헤더에 기재된 IP 주소와 포트 번호를 바꿔쓰는 것임
- 송신처의 IP 주소를 프라이빗 주소에서 글로벌 주소로 바꿔 씀  
  여기서 사용하는 글로벌 주소는 주소 변환 장치의 인터넷 측에 있는 포트에 할당된 주소로, 이것과 동시에 포트 번호도 바꾸어 씀
- 주소 변환 기능을 가지는 것은 라우터 뿐만 아니고 방화벽에도 주소 변환 기능이 존재
- 패킷을 주고받을 때는 대응표에서 프라이비트 주소와 글로벌 주소의 대응 관계를 조사하여 주소와 포트 번호를 바꿔쓰고 나서 패킷을 중계함

#### 포트 번호를 바꿔쓰는 이유
- 포트 번호를 바꿔쓰지 않으면 프라이비트 주소와 글로벌 주소가 1:1로 대응하여 인터넷에 접속하는 대수만큼 글로벌 주소가 필요
- 글로벌 주소는 동시 접속 대수만큼만 필요하긴 하지만, 사내의 사원 수가 많으면 동시에 액세스하는 인원 수도 늘어남
- 포트 번호를 바꿔쓰는 방법은 이러한 문제를 개선하기 위하 고안됨  
  클라이언트 측의 포트 번호를 무작위로 선택하여 사용할 뿐이므로, 바꿔써도 문제가 발생하지 않음
- 한 개의 글로벌 주소를 수만 개의 프라이비트 주소에 대응시킬 수 있음

#### 인터넷에서 회사로 엑세스한다
- 사내에서 인터넷으로 액세스하는 패킷을 중계할 때는 바꿔쓰는 글로벌 주소는 라우터(변환 장치)에 할당되어 있고, 포트번호는 아무거나 가져다가 쓰면 되므로, 대응표에 송신처의 프라이비트 주소와 포트 번호가 등록되어 있지 않아도 상관 없음
- 반대로 인터넷에서 사내로 패킷을 중계할 때는 대응표에 등록되어 있지 않으면 중계할 수 없음
- 즉 사내에서 의도적으로 인터넷에 엑세스하지 않는 한, 인터넷측에서 사내에 패킷을 보낼 수 없음  
  이것은 부정 침입을 방지하는 효과를 가지고 있음

#### 라우터의 패킷 필터링 기능
- 패킷 필터링 기능도 라우터에 중요한 부가 기능 중 하나
- 패킷을 중계할 때 MAC 헤더, IP 헤더, TCP 헤더에 기록되어 있는 내용을 조사하여 사전에 설정한 조건에 합치되면 패킷을 중계하거나 패기하는 동작을 실행함
- 대부분의 방화벽이라는 기기나 소프트웨어는 이 원리를 이용하여 부정 침입을 방지


## 용어 정리
- gateway
  - 두 네트워트 간의 톨게이트 역할을 수행
  - 즉, 두 네트워트 간의 프토로콜 통신 방식이 다를 때, 게이트웨이에서 이를 맞춰주는 역할을 수행    



