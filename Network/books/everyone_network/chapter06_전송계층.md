# chapter06 전송 계층 : 신뢰할 수 있는 데이터 전송하기
## 전송 계층의 두 가지 역할
- 전송 계층은 <b>목적지에 신뢰할 수 있는 데이터를 전달하기 위해서 필요</b>
- 앞서 물리 계층, 데이터링크계층, 네트워크 계층이 있으면 데이터를 목적지에 전송할 수 있지만, 데이터가 손상되거나 유실되더라도 이들 계층에서는 아무것도 해주지 않음
- 전송 계층에는 <b>오류를 점검하는 기능</b>이 존재. 오류가 발생하면 데이터를 재전송하도록 요청
- 전송 계층에서는 <b>전송된 데이터의 목적지가 어떤 애플리케이션인지 식별하는 기능도 있음</b>  
  예를 들어, 데이터가 웹 브라우저에서 사용하는지? 아니면 메일 프로그램에서 사용하는지? 등

## 연결형 통신과 비연결형 통신
- 전송 계층의 특징을 간단히 설명하면 <b>신뢰성/정확성과 효율성으로 구분할 수 있음</b>
- 신뢰성과 정확성은 데이터를 목적지에 문제없이 전달하는 것이고, 효율성은 데이터를 빠르고 효율적으로 전달하는 것
- 여기서 신뢰할 수 있고 정확한 데이터를 전달하는 통신을 <b>연결형 통신</b>, 효율적으로 데이터를 전달하는 통신을 <b>비연결형 통신</b>이라고 함
- 연결형 통신은 상대편과 확인해 가면서 통신하는 방식이며, 비연결형 통신은 상대편을 확인하지 않고 일방적으로 데이터를 전송하는 방식 
- 연결형 통신은 신뢰성/정확성이 우선인 통신이라 여러 번 확인하고 보내는 반면, 비연결형 통신은 효율성이 우선이므로, 확인 절차 없이 일방적으로 보내는 것
- 비연결형 통신은 보통 동영상에서 사용됨
- 전송 계층의 연결형 통신 프로토콜에는 TCP가 사용되고, 비연결형 통신 프로토콜에는 UDP가 사용됨

## TCP란? 
- 전송계층에서 신뢰할 수 있는 정확한 통신을 제공하는 프로토콜
- 네트워크 계층에서의 IP 헤더와 비슷하게, 전송계층에서 TCP로 전송할 때 붙이는 헤더를 <b>TCP 헤더</b>라고 하고, 이 TCP 헤더가 붙은 데이터를 <b>세그먼트(segment)</b>라고 함
- 연결형 통신은 꼼꼼하게 상대방을 확인하면서 데이터를 전송하는데, 데이터 전송 전 해야 하는 작업이 있음
- 데이터를 전송하려면 <b>연결(connection)</b>이라는 가상의 독점 통신로를 확보해야 함. 이 연결을 확립한 후에 데이터를 전송할 수 있음
- TCP 헤더의 코드 비트 부분이 있는데, 헤더의 107번째 비트부터 112번째 비트까지의 6비트로 연결의 제어 정보가 기록되는 곳
![img](https://github.com/koni114/Network/blob/master/img/network_36.JPG)
- 코드 비트는 각 비트별로 역할이 있음. 초깃값은 0이고 비트가 활성화되면 1이 됨
- 연결을 확립하려면 <b>SYN과 ACK가 필요</b>
- SYN은 연결요청, ACK는 확인 응답을 뜻함

## 3-way 핸드셰이크란? 
- 연결(connection)은 아래 그림과 같이 SYN과 ACK를 사용하여 확립할 수 있음
- 신뢰할 수 있는 연결을 하려면 데이터를 전송하기 전에 패킷을 교환하는데, 다음 그림처럼 세 번 확인
![img](https://github.com/koni114/Network/blob/master/img/network_37.JPG)
- 이처럼 데이터를 보내기 전에 연결을 확립하기 위해 패킷 요청을 세 번 교환하는 것을 3-way 헨드셰이크라고 함  
  여기서 핸드셰이크는 사람들이 상대방을 확인하고 악수를 하는 것처럼 데이터 통신에서도 확실하게 데이터가 전송되었는지 확인하면서 이루어지는 통신 수단
- 연결을 끊을 때도 끊기 위한 요청을 교환해야 함. FIN과 ACK를 사용하는데, <b>FIN는 연결 종료를 뜻함</b>
- 연결을 종료할 때는 FIN과 ACK가 1로 활성화됨

## 일련번호와 확인 응답 번호의 구조
- 3-way 핸드셰이크가 끝나고 실제 데이터를 보내거나 상대방이 받을 떄는 TCP 헤더의 일련번호(sequence number)와 확인 응답 번호(acknowledgement number)를 사용
- TCP는 데이터를 분할해서 보내는데 일련번호는 송신 측에서 수신 측에 이 데이터가 몇 번째 데이터 인지를 알려주는 역할 수행
- 전송된 데이터에 일련번호를 부여하면 수신자는 원래 데이터의 몇 번째 데이터를 받았는지 알 수 있음
- 확인 응답 번호는 수신 측이 몇 번째 데이터를 수신했는지  송신 측에 알려주는 역할 수행. 이 번호는 다음 번호의 데이터를 요청하는 데도 사용됨. 예를 들어 10번 데이터를 수신하면 11번 데이터를 송신 측에 요청
- 이를 <b>확인 응답</b>이라고 함
- 아래 그림에서의 데이터 통신 흐름을 생각해보자. 일련번호 '3001'은 지금 보내는 200바이트 데이터의 첫 번째 바이트 번호이며, 확인 응답 번호는 다음에 보냈으면 하는 데이터의 첫 번째 바이트 번호가 됨
![img](https://github.com/koni114/Network/blob/master/img/network_38.JPG)
- 위의 1 ~ 4번 과정에서 데이터 전송이 완료될 때까지 반복하는 것
- 항상 데이터가 정상적이게 전달되는 것은 아니므로, 일련번호와 확인 응답 번호를 사용해서 데이터가 손상되거나 유실된 경우에 데이터를 재전송하게 되어 있음. 이것을 <b>재전송 제어</b>라고 함
- 데이터를 전송하는 도중에 오류가 발생하면 일정 시간 동안 대기한 후에 재 전송함

## 윈도우 크기란? 
- 세그먼트(데이터) 하나를 보낼 때마다 확인 응답을 한 번 반환하는 통신이였음
- 이와 같은 통신은 한 번 보낼 때마다 한 번 응답을 반환하는 방식어어서 효율이 높지 않음
- 하지만 매번 확인 응답을 기다리는 대신 세그먼트를 연속해서 보내고 난 다음에 확인 응답을 반환하면 효율이 높아짐
- 세그먼트를 일시적으로 저장하는 장소가 <b>buffer</b>라고 함
- 버퍼 덕분에 세그먼트를 연속해서 보내도 수신 측은 대응할 수 있고 확인 응답의 효율도 높음
- 수신 측은 대량으로 데이터가 전송되면 보관하지 못하고 넘치는데 이것을 <b>오버플로(overflow)</b>라고 함
- 그래서 오버플로가 발생하지 않도록 버퍼의 한계 크기를 알고 있어야 함. 그것이 TCP 헤더의 <b>윈도우 크기(window size)</b>값에 해당하는 것
- 윈도우 크기는 얼마나 많은 용량의 데이터를 저장해 둘 수 있는지를 나타내는 것
- 윈도우 크기의 초깃값은 3-way 헨드셰이크를 할 때 판단함. 아래 예제에서는 컴퓨터 1의 한계 값이 3000바이트이고 컴퓨터 2의 한계값이 2000바이트가 됨
![img](https://github.com/koni114/Network/blob/master/img/network_39.JPG)

## 포트 번호란?
- 전송 계층은 연결 확립, 재전송 제어, 윈도우 제어 외에도 목적지가 어떤 애플리케이션인지 구분하는 역할을 수행 
- 애플리케이션을 구분할 수 있도록 <b>출발지 포트 번호(source port number)</b>와 <b>목적지 포트 번호(destination port number)</b>가 필요
- TCP 헤더에 포트 번호가 있기 때문에 애플리케이션 구분 가능. 포트 번호는 0 ~ 65535번 사용 가능
- <b>0~1023번 포트</b>는 주요 프로토콜이 사용하도록 예약되어 있음. 이러한 포트를 잘 <b>알려진 포트(well-known ports)</b>라고 하고 <b>1025 이상은 랜덤 포트라고 해서 클라이언트 측의 송신 포트</b>로 사용
- 0 ~ 1023번 포트는 일반적으로 사용하는 서버 측 애플리케이션에서 사용
- 다음은 서버에서 주로 사용하는 애플리케이션 번호임
![img](https://github.com/koni114/Network/blob/master/img/network_40.JPG)
- 이처럼 동작하는 애플리케이션은 각각 포트 번호가 있어서 다른 애플리케이션과 구분됨  
  데이터를 전송할 때는 상대방의 IP 주소가 필요하지만, 어떤 애플리케이션이 사용되고 있는지 구분하려면 TCP는 포트 번호가 필요 
- 포트 번호를 붙이지 않고 통신하면 컴퓨터에 데이터가 도착하더라도 애플리케이션까지는 도착할 수 없음
- 아래 그림과 같이 컴퓨터 1에서 컴퓨터 2까지 포트 번호를 붙여서 통신하면 확실하게 원하는 애플리케이션까지 데이터를 보낼 수 있음
- 컴퓨터 1의 웹 브라우저로는 1025번 포트 번호가 할당돠는데, 웹 브라우저로 접속할 때 웹 브라우저에는 임의의 포트가 자동으로 할당됨. 그래서 서버 측에서는 포트 번호를 정해둬야 하지만 클라이언트 측은 정하지 않아도 됨
![img](https://github.com/koni114/Network/blob/master/img/network_41.JPG)

## UDP란? 
- UDP는 비연결형 통신이라 데이터를 전송할 때 TCP처럼 시간이 걸리는 확인 작업을 일일이 하지 않음
- UDP의 장점은 데이터를 효율적으로 빠르게 보내는 것이라서 스트리밍 방식으로 전송하는 동영상 서비스와 같은 곳에 사용됨

## UDP 헤더란 ?
- UDP 헤더가 붙은 데이터를 UDP 데이터그램이라고 함
- 다음은 TCP 세그먼트 통신과 UDP 세그먼트 통신의 차이
![img](https://github.com/koni114/Network/blob/master/img/network_42.JPG)
- 또한 UDP를 사용하면 랜에 있는 컴퓨터나 네트워크 장비에 데이터를 일괄로 보낼 수 있음  
  이를 브로드케스트라고 함
- TCP는 데이터를 전송할 때도 확인 응답을 하나씩 보내야 하니 브로드캐스트와 같이 불특정 다수에게 보내는 통신에는 적합하지 않음